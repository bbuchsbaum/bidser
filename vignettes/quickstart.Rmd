---
title: "Getting Started with bidser"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Getting Started with bidser}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```


## Brief Introduction to `bidser`

`bidser` is an R package for working with the [BIDS](https://bids.neuroimaging.io/) neuroimaging projects. The goal of the package is to allow one to query files that are stored in a hierarchical BIDS structure. Below we load in a BIDS example project, which is stored and accessed through a `bids_project` object.

There is a Python package called [pybids](https://github.com/bids-standard/pybids) that can be used to work with BIDS in Python and is more developed.
```{r echo=FALSE}
library(bidser)
```

```{r setup}

library(bidser)
library(tibble)
library(dplyr)
library(gluedown)

# Download example BIDS dataset
tryCatch({
  ds001_path <- get_example_bids_dataset("ds001")
  proj <- bids_project(ds001_path)
  
  print(proj)
}, error = function(e) {
  message("This vignette requires an internet connection to download example data.")
  message("Error: ", e$message)
  knitr::knit_exit()
})

```

We can see that this is a project with multiple participants with anatomical and functional scans and a task called **balloonanalogrisktask**.

We can also make some basic queries of the project to gather information. For example, does the project have any "sessions"?

```{r}

sessions(proj)
```

No sessions. And what are the participant ids?

```{r}
sids <- participants(proj)
```

```{r, results="asis", echo=FALSE}

gluedown::md_bullet(sids)

```

Does it have task event files?

```{r}


fnames <- head(basename(event_files(proj)), n=3)
## print the first three event files

```

```{r, echo=FALSE, results='asis'} 

gluedown::md_order(fnames, seq = FALSE)
```


## Searching the BIDS structure

Lets now search for some arbitrary files. For example, we wish to retrieve all the "T1w" anatomical images.


```{r, echo=FALSE, results='asis'} 

t1w <- search_files(proj, "T1w")

```

```{r, echo=FALSE, results='asis'} 

gluedown::md_bullet(t1w)
```

Now we search for any scans containing the string "bold".

```{r, results='asis'} 

bold <- search_files(proj, "bold")

## take the first 5 files, since there are alot.
bold <- head(bold, 5)
```

```{r, echo=FALSE, results='asis'} 

gluedown::md_bullet(bold)
```


## Specialized querying functions

If we are only interested in functional bolds scans (rather than any file with "bold" in it), there is a special function called `func_scans` to return such files

```{r, results='asis'} 

fscans <- func_scans(proj)

## take the first 5 files, since there are alot.
fscans <- head(fscans, 5)
```

```{r, echo=FALSE, results='asis'} 

gluedown::md_bullet(fscans)
```

Suppose though that we only want the scans from a specific subject? Let's try the first subject:

```{r, results='asis'} 

first_subject <- participants(proj)[1]
fscans_sub <- func_scans(proj, subid=first_subject)

```

```{r, echo=FALSE, results='asis'}

if (length(fscans_sub) > 0) {
  gluedown::md_bullet(basename(fscans_sub))
} else {
  cat("No scans found for subject", first_subject, "\n")
}
```

## Reading in Task Event files

BIDS event files describe the event-structure of *f*mri experiments. They can be easy read in to R as a set of `data.frame`s using the `read_events` function. As can be seen in the output below, `read_events` returns a `data.frame` with four columns: `.subid`, `.run`, `.task`, `data`. The `data` is nested in the table because there is no guantee that all events files have the same columns (for example, event files associated with different tasks). 

```{r}

evs <- read_events(proj)
head(evs)

```

Now we can filter the table as we like, for example, to extract the data only from the first participant. We can then "unnest" the `data` variable to access the actual event structure.

```{r, result="asis"}
library(tidyr)
library(dplyr)

first_participant <- participants(proj)[1]
ev1 <- evs %>% dplyr::filter(.subid == first_participant) %>% unnest(cols=c(data))
head(ev1)
```


## Reading files produced by FMRIPrep

If you have processed a dataset with FMRIPrep, `bidser` can be used to read in the many of the resultant derivative files. If a project has an FMRIPrep derivatives folder, then we can read in the BIDS hierarchy plus derivatives as follows:

```{r}
# Try to get a derivatives dataset - note this may not be available
tryCatch({
  # Some BIDS examples may have derivatives, or we can demonstrate with empty structure
  deriv_path <- get_example_bids_dataset("ds000001-fmriprep")
  proj_deriv <- bids_project(deriv_path, fmriprep=TRUE)
  
  print(proj_deriv)
  
  # Now we can access various derivative files with convenience functions.
  # For example, to read in "preproc" scans we can use the `preproc_scans` function.
  pscans <- preproc_scans(proj_deriv)
  if (!is.null(pscans) && length(pscans) > 0) {
    print(head(as.character(pscans)))
  } else {
    message("No preprocessed scans found in this example dataset")
  }
  
  # Clean up derivatives dataset
  unlink(deriv_path, recursive=TRUE)
  
}, error = function(e) {
  message("Derivatives example not available: ", e$message)
  message("This is normal - not all BIDS examples include fMRIPrep derivatives.")
})
```

```{r cleanup, include=FALSE}
# Clean up the downloaded dataset
if (exists("ds001_path")) {
  unlink(ds001_path, recursive=TRUE)
}
```
